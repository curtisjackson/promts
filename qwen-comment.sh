#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ª–∏ –∫–æ–º–∞–Ω–¥–∞ qwen
if ! command -v qwen &> /dev/null; then
    echo "–û—à–∏–±–∫–∞: –∫–æ–º–∞–Ω–¥–∞ 'qwen' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ PATH."
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ."
    exit 1
fi

# –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
files=(
    "@/bitrix/form.result.new/"
    "@/bitrix/menu//"
    "@/bitrix/news.detail/"
)

echo "–ù–∞—á–∏–Ω–∞—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É ${#files[@]} —Ñ–∞–π–ª–æ–≤..."
echo "---------------------------------------------------------"

for file in "${files[@]}"; do
    echo "üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞: $file"

    # –ó–∞–ø—É—Å–∫ –∫–æ–º–∞–Ω–¥—ã
    # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ï—Å–ª–∏ qwen —Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–≤–æ–¥–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç–∞–∫–æ–º —Ä–µ–∂–∏–º–µ
    qwen -p -y "/comment $file" --output-format stream-json --include-partial-messages

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã
    if [ $? -ne 0 ]; then
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: $file"
        echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞."
        exit 1
    fi

    echo "‚úÖ –£—Å–ø–µ—à–Ω–æ: $file"
    echo "---------------------------------------------------------"
done

echo "üéâ –í—Å–µ —Ñ–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã!"
